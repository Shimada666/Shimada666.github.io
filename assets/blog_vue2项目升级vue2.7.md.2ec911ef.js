import{_ as s,c as a,o as n,O as l}from"./chunks/framework.1deebb9d.js";const A=JSON.parse('{"title":"Vue2项目升级Vue2.7","description":"","frontmatter":{"title":"Vue2项目升级Vue2.7","tags":["前端","vue"]},"headers":[],"relativePath":"blog/vue2项目升级vue2.7.md","filePath":"blog/vue2项目升级vue2.7.md","lastUpdated":1685801417000}'),p={name:"blog/vue2项目升级vue2.7.md"},o=l(`<p>就在七月初，vue 发布了 vue2.7 版本。这个版本带来了 vue3 的 composition-api 与 script setup 等特性， 让无法迁移 vue3 的 vue2 用户也可以用上新特性，使开发更便捷。</p><p>当然，vue2.7 升级也是有一些成本的，如某些插件需要更新版本、如果原先使用了 @vue/composition-api, unplugin-vue2-script-setup 等插件， 还需要对代码做相应的改造，接下来介绍一下我们该如何改造。</p><h2 id="项目简介" tabindex="-1">项目简介 <a class="header-anchor" href="#项目简介" aria-label="Permalink to &quot;项目简介&quot;">​</a></h2><p>我的项目是一个 2020 年 4 月创建的一个项目，不算新但也不算老，使用 vue + ts 开发。在后续经历过几次升级， 如引入 composition-api、unplugin-vue2-script-setup、vite 等插件，使用 vue3 的方式来开发项目。但是使用起来不知道是不是姿势问题， 还是有一些 bug, 因此这次打算升级到原生就支持这些的 vue2.7 版本，来彻底解决这些问题。</p><h2 id="踩坑" tabindex="-1">踩坑 <a class="header-anchor" href="#踩坑" aria-label="Permalink to &quot;踩坑&quot;">​</a></h2><h3 id="基础依赖替换" tabindex="-1">基础依赖替换 <a class="header-anchor" href="#基础依赖替换" aria-label="Permalink to &quot;基础依赖替换&quot;">​</a></h3><p>第一步，当然是上网查找资料查看前人总结的升级攻略。不过 vue2.7 刚出来，写指南的人也并不多，那我们就根据官网的指示， 把依赖替换。 由于我们的项目引入了 composition-api 等插件，所以我们先做基础替换</p><ul><li><code>vue</code> -&gt; 2.7.5 升级最新版本</li><li><code>unplugin-vue2-script-setup</code> -&gt; 删除（vue2.7提供了 script setup 功能）</li><li><code>vite-plugin-vue2</code> -&gt; 替换为官方提供的 <code>@vitejs/plugin-vue2</code></li><li><code>vue-template-compiler</code> -&gt; 根据官方手册，删除</li><li><code>@vue/composition-api</code> -&gt; 删除</li></ul><p>做完之后，删除 lock 文件与 node_modules，重新安装依赖。</p><h3 id="替换-composition-api-相关代码" tabindex="-1">替换 composition-api 相关代码 <a class="header-anchor" href="#替换-composition-api-相关代码" aria-label="Permalink to &quot;替换 composition-api 相关代码&quot;">​</a></h3><p>第二步，我们删除代码中引用 <code>@vue/composition-api</code> 的部分，并且把 <code>@vue/composition-api</code> 全局替换为 <code>vue</code>，因为这些内容 vue2.7 中有。</p><h3 id="更新-vite-config-ts" tabindex="-1">更新 vite.config.ts <a class="header-anchor" href="#更新-vite-config-ts" aria-label="Permalink to &quot;更新 vite.config.ts&quot;">​</a></h3><p>第三步，我们需要更新 <code>vite.config.ts</code> 的配置。更新很简单。原先使用了 <code>vite-plugin-vue2</code>、 <code>unplugin-vue2-script-setup/vite</code> 这两个依赖，我们把相关代码都删除， 然后引入 <code>@vitejs/plugin-vue2</code>。最终代码像这样。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">defineConfig</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vite</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> WindiCSS </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vite-plugin-windicss</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> vue </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@vitejs/plugin-vue2</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolve</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> env </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vite-plugin-env-compatible</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">defineConfig</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">plugins</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">vue</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">WindiCSS</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">preflight</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">env</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">  ]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">resolve</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">alias</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">resolve</span><span style="color:#A6ACCD;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./src</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">server</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8081</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">proxy</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">/api</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">target</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://localhost:8080</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">changeOrigin</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">css</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">preprocessorOptions</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">scss</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F07178;">additionalData</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">source</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fp</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// All scss files ending with imports.scss</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// will not re-import additionalData</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">fp</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">endsWith</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.scss</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// Use additionalData from legacy nuxt scss options</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">@import &quot;@/assets/style/share.scss&quot;; </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">}\`</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h3 id="升级-vue-echarts" tabindex="-1">升级 vue-echarts <a class="header-anchor" href="#升级-vue-echarts" aria-label="Permalink to &quot;升级 vue-echarts&quot;">​</a></h3><p>做完这些，我们发现项目使用到了新语法的页面会渲染两次。经过排查，发现是引入的 <code>vue-echarts(v6.0.2)</code> 插件有问题。</p><p>既然发现插件有问题，那么第四步，就是修复问题。我们到 vue-echarts 的 github 页面查看，发现已经有人提出了 issue，且作者给出了解决办法： 升级到 v6.2.0 版本。我们尝试升级之后，发现问题解决。查看原因是因为旧版本 vue-echarts 的依赖 vue-demi 指定了 ^0.12.x 的版本， 而 vue-demi 需要 0.13.x 才开始支持。</p><h3 id="升级-vueuse" tabindex="-1">升级 vueuse <a class="header-anchor" href="#升级-vueuse" aria-label="Permalink to &quot;升级 vueuse&quot;">​</a></h3><p>做完这些之后，项目能跑起来了，但是测试发现还是有些问题。排查到是使用了 <code>vueuse</code> 的 <code>useVModel</code> 报错了。那么第五步，上github 查找 issue，发现已经有人提过且 pr 了。艾特了作者请求合并 pr，作者很快合并且 release 了新版本 v8.9.3，升级版本后成功解决问题</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>至此，我们的项目就成功跑起来了。总的升级时间零零散散花了两天，主要还是排查问题上多耗费了些时间。但对于升级后的开发效率，这些都是值得的， vue2.7 + vite 的开发方式能极大提升开发效率与体验，让开发不再痛苦，对于有时间的朋友，非常推荐将项目升级到 vue2.7 来。</p>`,21),e=[o];function t(c,r,D,i,y,F){return n(),a("div",null,e)}const u=s(p,[["render",t]]);export{A as __pageData,u as default};
