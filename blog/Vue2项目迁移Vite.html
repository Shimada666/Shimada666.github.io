<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2项目迁移Vite | 鼠鼠屋 🐭</title>
    <meta name="description" content="一些简单的东西">
    <link rel="stylesheet" href="/assets/style.6b537e8f.css">
    <link rel="modulepreload" href="/assets/app.0500f9da.js">
    <link rel="modulepreload" href="/assets/blog_Vue2项目迁移Vite.md.80c96c75.lean.js">
    
    <meta name="twitter:title" content="Vue2项目迁移Vite | 鼠鼠屋 🐭">
  <meta property="og:title" content="Vue2项目迁移Vite | 鼠鼠屋 🐭">
  </head>
  <body>
    <div id="app"><div><!--[--><div class="theme"><header class="nav-bar" data-v-1b98150f><div class="sidebar-button" data-v-1b98150f><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="鼠鼠屋 🐭, back to home" data-v-1b98150f data-v-128f6faf><!----> 鼠鼠屋 🐭</a><div class="flex-grow" data-v-1b98150f></div><div class="nav" data-v-1b98150f><nav class="nav-links" data-v-1b98150f data-v-c6c99ff2><!--[--><div class="item" data-v-c6c99ff2><div class="nav-link" data-v-c6c99ff2 data-v-25960e74><a class="item" href="/" data-v-25960e74>主页 <!----></a></div></div><div class="item" data-v-c6c99ff2><div class="nav-link" data-v-c6c99ff2 data-v-25960e74><a class="item" href="/tags" data-v-25960e74>分类 <!----></a></div></div><div class="item" data-v-c6c99ff2><div class="nav-link" data-v-c6c99ff2 data-v-25960e74><a class="item isExternal" href="https://github.com/Shimada666" target="_blank" rel="noopener noreferrer" data-v-25960e74>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-25960e74><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-ef7edbf4><nav class="nav-links nav" data-v-ef7edbf4 data-v-c6c99ff2><!--[--><div class="item" data-v-c6c99ff2><div class="nav-link" data-v-c6c99ff2 data-v-25960e74><a class="item" href="/" data-v-25960e74>主页 <!----></a></div></div><div class="item" data-v-c6c99ff2><div class="nav-link" data-v-c6c99ff2 data-v-25960e74><a class="item" href="/tags" data-v-25960e74>分类 <!----></a></div></div><div class="item" data-v-c6c99ff2><div class="nav-link" data-v-c6c99ff2 data-v-25960e74><a class="item isExternal" href="https://github.com/Shimada666" target="_blank" rel="noopener noreferrer" data-v-25960e74>Github <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-25960e74><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-ef7edbf4><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#为什么使用-vite-开发？">为什么使用 Vite 开发？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#迁移前的项目介绍">迁移前的项目介绍</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#如何迁移？">如何迁移？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#迁移实操">迁移实操</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#无痛迁移">无痛迁移</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#手工迁移">手工迁移</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#迁移结果">迁移结果</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-0df8c27e><div class="container" data-v-0df8c27e><!--[--><!--[--><!----><!--]--><!--[--><div class="page-header style-text" data-v-cb811eac><div class="post-heading" data-v-cb811eac><div class="tags" data-v-cb811eac><!--[--><a class="tag" title="前端" data-v-cb811eac>前端</a><a class="tag" title="vue" data-v-cb811eac>vue</a><!--]--></div><h1 data-v-cb811eac>Vue2项目迁移Vite</h1><div class="subheading" data-v-cb811eac></div><span class="meta" data-v-cb811eac>Last Updated on 2022-07-20</span></div></div><!--]--><!--]--><div style="position:relative;" class="content" data-v-0df8c27e><div><p>众所周知，大多数的 vue2 项目都是用 vue-cli 创建的，但是众所周知 vue-cli 创建的项目，vue-cli 是基于 webpack 的，冷启动以及热重载速度均远不及 vite。<br> 那么，这样的项目，在迁移 vite 中，会遇到什么问题？<br> 本博客将记录 vue2 + ts 的项目迁移至 vue 的一些经验，希望对大家有所帮助。</p><h2 id="为什么使用-vite-开发？" tabindex="-1">为什么使用 Vite 开发？ <a class="header-anchor" href="#为什么使用-vite-开发？" aria-hidden="true">#</a></h2><p>vite 是新一代的前端开发与构建工具，区别于 webpack, 它的开发服务器基于 es modules 机制，提供给用户快到惊人的热更新功能。<br> 举个例子，一个使用 vue2 的 vue-cli 项目可能需要启动 30-60 秒，但如果迁移到 vite，那么启动甚至可至 1 秒内，这就是 vite 的优势了。</p><h2 id="迁移前的项目介绍" tabindex="-1">迁移前的项目介绍 <a class="header-anchor" href="#迁移前的项目介绍" aria-hidden="true">#</a></h2><p>这个项目是 2020 年开始开发的。项目使用 vue-cli4 创建，使用 vue2 + ts 为主要技术栈，前中期大量使用 <code>vue-class-component</code> 的方式的类组件来进行开发。 在 vue3 出现后，引入了 <code>@vue/composition-api</code> 与 <code>unplugin-vue2-script-setup</code> 进行开发。编写代码体验已经和写 vue3 很相似了，但是开发时的启动速度仍然是一大痛点。</p><h2 id="如何迁移？" tabindex="-1">如何迁移？ <a class="header-anchor" href="#如何迁移？" aria-hidden="true">#</a></h2><p>要知道如何迁移，就必须调研 vite 与 vue-cli 使用上有哪些区别。总结下来，主要有这几点</p><ol><li><code>public.html</code> 位置的不同，vue-cli 中是 <code>public/index.html</code>，而 vite 中直接是根目录下的 <code>index.html</code>。</li><li>配置文件的不同。vue-cli 使用的 <code>vue.config.js</code> 文件, vite 中使用的是 <code>vite.config.js</code>。且配置也有一定差异。比如全局 css 文件的引入方式。vue-cli 使用的是</li></ol><div class="language-javascript"><pre><code><span class="token comment">// vue.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">loaderOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">sass</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">prependData</span><span class="token operator">:</span> <span class="token string">&#39;@import &quot;@/assets/style/share.scss&quot;;&#39;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而 vite 中使用的是</p><div class="language-typescript"><pre><code><span class="token comment">// vite.config.ts</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  css<span class="token operator">:</span> <span class="token punctuation">{</span>
    preprocessorOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      scss<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">additionalData</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> fp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// All scss files ending with imports.scss</span>
          <span class="token comment">// will not re-import additionalData</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.scss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source
          <span class="token comment">// Use additionalData from legacy nuxt scss options</span>
          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@import &quot;@/assets/style/share.scss&quot;; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>使用 vite 必须库原生支持 esm 的模式。通常可以通过升级库解决。</li><li>环境变量使用方式的不同。vue-cli 中是通过 <code>process.<wbr>env.xxxx</code> 来使用环境变量，而 vite 中是通过 <code>import.<wbr>meta.env.xxxx</code> 来使用。这一点可用 <code>vite-plugin-env-compatible</code> 抹平差距。</li></ol><p>了解了以上四点。就可以开始迁移了。</p><h2 id="迁移实操" tabindex="-1">迁移实操 <a class="header-anchor" href="#迁移实操" aria-hidden="true">#</a></h2><p>在生产项目迁移时，我们通常都希望能在使用上新功能的同时，也保留旧功能，如果发生故障可以随时切换旧功能完成修复。 因此，在引入 vite 的同时保留 vue-cli 的方式就是我们迁移的重点。生产环境，安全第一。 同时，引入 vite 并不意味着我们要使用 vite 的打包功能，我们仍然可以使用 vue-cli 的打包功能，保证生产环境的稳定与兼容性。</p><h3 id="无痛迁移" tabindex="-1">无痛迁移 <a class="header-anchor" href="#无痛迁移" aria-hidden="true">#</a></h3><p>首先要介绍一款插件。<a href="https://github.com/IndexXuan/vue-cli-plugin-vite" target="_blank" rel="noopener noreferrer">vue-cli-plugin-vite</a> 这个插件可以方便我们无痛迁移 vue-cli 至 vite 并保留 vue-cli 的能力。 此插件复用了 vue.config.js，大部分配置都不需要修改。基本上可以做到开箱即用，无痛体验 vite 的启动速度。</p><h3 id="手工迁移" tabindex="-1">手工迁移 <a class="header-anchor" href="#手工迁移" aria-hidden="true">#</a></h3><p>这也是我使用的迁移方式。因为我觉得复用原有代码的方式太过丑陋，同时迁移所需的配置项也没那么多。因此我们对于上文提到的 1-4 点说一下我们是怎么做的。</p><ol><li>index.html 的迁移非常简单，创建一份 <code>index.html</code> 到根目录即可</li><li>配置文件也好解决，创建一个 <code>vite.config.ts</code> 即可</li><li>库必须是 esm 这一点，我遇到了使用的 vue-echarts 不兼容的问题。查看 github，发现把版本升级到 &gt;6.0.0 即可解决。于是按照文档升级版本后迁移至 v6 版本解决。</li><li>环境变量的问题，我直接使用了 <code>vite-plugin-env-compatible</code> 库帮助我导入所有环境变量。作为插件配置在 <code>vite.config.ts</code> 即可。</li></ol><h2 id="迁移结果" tabindex="-1">迁移结果 <a class="header-anchor" href="#迁移结果" aria-hidden="true">#</a></h2><p>迁移后，项目启动时间从 30-60 秒降至 1 秒，同时保留了原有的开发、打包方式，把风险降到了最低。至此，本文结束。</p></div></div><footer class="page-footer" data-v-0df8c27e data-v-1bc42688><div class="edit" data-v-1bc42688><div class="edit-link" data-v-1bc42688 data-v-60fa6c8f><!----></div></div><div class="updated" data-v-1bc42688><p class="last-updated" data-v-1bc42688 data-v-061fcb47><span class="prefix" data-v-061fcb47>Last Updated:</span><span class="datetime" data-v-061fcb47></span></p></div></footer><!----><!--[--><!--[--><!--]--><!--[--><!----><!--]--><!--]--></div></main></div><!----><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"blog_buildblog.md\":\"c8f70159\",\"blog_paindiary.md\":\"4ddc88bd\",\"blog_springboot项目规范.md\":\"6fb95f4f\",\"blog_vue2项目迁移vite.md\":\"80c96c75\",\"blog_vue2项目升级vue2.7.md\":\"19e0d693\",\"blog_使用mockito帮助单测.md\":\"17ebe905\",\"blog_初探plantuml.md\":\"345bb66c\",\"blog_容器分析工具.md\":\"1f9905d2\",\"index.md\":\"18d71b91\",\"tags.md\":\"d79a1d09\"}")</script>
    <script type="module" async src="/assets/app.0500f9da.js"></script>
    
  </body>
</html>